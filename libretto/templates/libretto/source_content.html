{% load thumbnail i18n static_grouper routines %}

{% with specific=source.specific %}
  {% if source.is_audio or source.is_video or source.is_other %}
    <ul class="list-unstyled">

      {% if source.is_audio %}
        <li>
          <audio controls preload="auto">
            {% if request.user.is_authenticated or not specific.extrait_ogg and not specific.extrait_mpeg %}
              {% include 'libretto/audio_source.html' with fichier=specific.fichier_ogg mimetype='audio/ogg' %}
              {% include 'libretto/audio_source.html' with fichier=specific.fichier_mpeg mimetype='audio/mpeg' %}
            {% else %}
              {% include 'libretto/audio_source.html' with fichier=specific.extrait_ogg mimetype='audio/ogg' %}
              {% include 'libretto/audio_source.html' with fichier=specific.extrait_mpeg mimetype='audio/mpeg' %}
            {% endif %}
          </audio>
        </li>
      {% endif %}

      {% if source.is_video %}
        <li>
          <video width="640" height="360" controls preload="auto">
            {% if request.user.is_authenticated or not specific.extrait_ogg and not specific.extrait_mpeg %}
              {% include 'libretto/video_source.html' with fichier=specific.fichier_ogg mimetype='video/ogg' width=specific.largeur height=specific.hauteur %}
              {% include 'libretto/video_source.html' with fichier=specific.fichier_mpeg mimetype='video/mp4' width=specific.largeur height=specific.hauteur %}
            {% else %}
              {% include 'libretto/video_source.html' with fichier=specific.extrait_ogg mimetype='video/ogg' width=specific.largeur_extrait height=specific.hauteur_extrait %}
              {% include 'libretto/video_source.html' with fichier=specific.extrait_mpeg mimetype='video/mp4' width=specific.largeur_extrait height=specific.hauteur_extrait %}
            {% endif %}
          </video>
        </li>
      {% endif %}

      {% addstatic js %}
        <script>
          function getModalOpener (media) {
            var modalId = $(media).parents('.modal')[0].id;
            return $('[data-target="#' + modalId + '"]');
          }
          $(function () {
            $('audio, video').off('play').on('play', function (e) {
              $('audio, video').not(this).trigger('pause');
              getModalOpener(this).addClass('active');
              this.play();
              e.preventDefault();
            }).off('pause').on('pause', function (e) {
              this.pause();
              getModalOpener(this).removeClass('active');
              e.preventDefault();
            });
          });
        </script>
      {% endaddstatic %}

      {% if source.is_other %}
        <li>
          <a href="{{ source.fichier.url }}">
            <i class="fa fa-paperclip"></i>
            {{ source.filename }} ({{ source.fichier.size|filesizeformat }})
          </a>
        </li>
      {% endif %}

    </ul>
  {% endif %}

  {% if source.images %}
    <div id="reader-{{ source.pk }}" class="reader">
      <div class="btn-group">
        <a href="#" class="zoom btn btn-default">
          <i class="fa fa-fw fa-search-plus"></i>
        </a>
        <a href="#" class="save btn btn-default">
          <i class="fa fa-fw fa-save"></i>
        </a>
        <a href="#" class="print btn btn-default">
          <i class="fa fa-fw fa-print"></i>
        </a>
      </div>
      <div class="row">
        <a href="#" class="prev col-xs-1 btn btn-link invisible">
          <i class="fa fa-angle-left fa-5x"></i>
        </a>
        <div class="main-container col-xs-10">
          <div class="spinner-container">
            <i class="fa fa-spinner fa-spin fa-5x"></i>
          </div>
          <div class="img-container">
            <img src="" />
          </div>
        </div>
        <a href="#" class="next col-xs-1 btn btn-link invisible">
          <i class="fa fa-angle-right fa-5x"></i>
        </a>
      </div>
      <div class="page-form input-group input-group-sm">
        <input type="number" name="page" class="form-control" min="1" />
        <span class="count input-group-addon"></span>
      </div>
      <div class="btn-group linked-objects"></div>
    </div>
    {% addstatic js %}
      <script>
        $(function () {
          var images = [
            {% for image in source.images %}
              {% thumbnail image.fichier 'small' as small %}
              {% thumbnail image.fichier 'medium' as medium %}
              {
                small: '{{ small.url }}',
                medium: '{{ medium.url }}',
                original: '{{ image.fichier.url }}',
                linkedObjects: {{ image.get_linked_objects_json|safe }}
              }{% if not forloop.last %},{% endif %}
              {% addstatic metadata %}
                <meta property="og:image" content="http{% if request.is_secure %}s{% endif %}://{{ request.get_host }}{{ small.url }}" />
                <meta property="og:image:width" content="{{ small.width }}" />
                <meta property="og:image:height" content="{{ small.height }}" />
              {% endaddstatic %}
            {% endfor %}
          ];
          new Reader($('#reader-{{ source.pk }}'), images);
        });
      </script>
    {% endaddstatic %}
  {% endif %}
{% endwith %}


{% if source.transcription %}
  <blockquote class="source">

    <div class="transcription">
      {{ source.transcription|safe }}
    </div>
    {% if source.auteurs.exists %}
      <footer class="auteurs">
        {{ source.auteurs_html }}
      </footer>
    {% endif %}

  </blockquote>
{% endif %}

{% if source.url %}
  <a href="{{ source.url }}" target="_blank">
    <i class="fa fa-external-link fa-fw"></i> {{ source.url }}
  </a>
{% endif %}

{% addstatic js %}
  <script>
    tooltips_reload();
  </script>
{% endaddstatic %}
